import{a as j}from"./index-xsH4HHeE.js";import{K as a,aC as y}from"./index-CSkJ4Wth.js";import{u as f}from"./auth-CnjZ6pwZ.js";const c=j.create({baseURL:"http://vivighr.vip:8111/api",timeout:12e4,withCredentials:!0});let u=!1;c.interceptors.request.use(t=>{const e=f().token;return e&&(t.headers.Authorization=`Bearer ${e}`),t},t=>Promise.reject(t));c.interceptors.response.use(t=>{const{code:r,message:e,data:l}=t.data,o=t.config.silent;return r===200?(e&&!o&&a({title:"成功",message:e,type:"success",position:"top-right"}),l):(console.error(e),a({title:"错误",message:e||"请求失败",type:"error",position:"top-right"}),Promise.reject(new Error(e)))},t=>{var r,e;return((r=t.response)==null?void 0:r.status)===401&&!u?(u=!0,f().clearAuth(),a({title:"错误",message:"登录过期，请重新登录",type:"error",position:"top-right"}),y.push({name:"Login"}).finally(()=>{u=!1})):((e=t.response)==null?void 0:e.status)!==401&&(console.error("网络错误:",t.message),a({title:"错误",message:t.message||"网络错误，请稍后重试",type:"error",position:"top-right"})),Promise.reject(t)});const N={get(t,r){return c.get(t,r)},post(t,r,e){const l={...(e==null?void 0:e.headers)||{},...r instanceof FormData?{"Content-Type":"multipart/form-data"}:{}},o={...e,headers:l,silent:e==null?void 0:e.silent};return c.post(t,r,o)},put(t,r,e){return c.put(t,r,e)},delete(t,r){return c.delete(t,r)},stream(t,r,e={}){const o=f().token,w={"Content-Type":"application/json",...o?{Authorization:`Bearer ${o}`}:{},...e.headers||{}};return fetch(`http://vivighr.vip:8111/api${t}`,{method:"POST",headers:w,body:JSON.stringify(r),mode:"cors",signal:e.signal}).then(async i=>{if(!i.ok){const s=new Error(`HTTP error! status: ${i.status}`);throw i.status===401&&!u?(u=!0,f().clearAuth(),a({title:"错误",message:"登录过期，请重新登录",type:"error",position:"top-right"}),await y.push({name:"login"}),u=!1):a({title:"错误",message:`请求失败: ${i.statusText||"未知错误"}`,type:"error",position:"top-right"}),s}if(!i.body){const s=new Error("Response body is not available");throw a({title:"错误",message:"响应体不可用",type:"error",position:"top-right"}),s}const m=i.body.getReader(),b=new TextDecoder("utf-8");let n="";return new ReadableStream({async start(s){try{for(;;){const{done:p,value:k}=await m.read();if(p){if(n)try{const h=JSON.parse(n.slice(5));s.enqueue(h)}catch{console.warn("忽略无效的剩余数据:",n)}s.close();break}const v=b.decode(k,{stream:!0});n+=v;const d=n.split(`
`);n=d.pop()||"";for(const h of d)if(h.startsWith("data:"))try{const g=h.slice(5).trim();if(g){const S=JSON.parse(g);s.enqueue(S)}}catch{console.warn("忽略无效的 JSON 数据:",h)}}}catch(p){s.error(p)}finally{m.releaseLock()}},cancel(){m.releaseLock()}})})}};export{N as r};
